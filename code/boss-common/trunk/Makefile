#
# Makefile
#
# build dependencies: >=boost-1.46.0, curl, utf8
#   see Build Instructions.html for how to set up utf8
#
# runtime dependencies: wrestool, tr, sed
#   wrestool is part of the icoutils package, and is called programatically
#   to extract the version information from the OBSE dll
#
# usage:
#   make [options] [targets]
#
# options:
#     each of these options modify compilation flags, so you should run
#     'make clean' before switching among combinations of them.
#   debug                       set to 'y' to enable debug symbols
#   profile                     set to 'y' to enable profiling (used by gprof)
#   coverage                    set to 'y' to enable coverage analysis
#
# examples:
#   make                        builds build/boss
#   make DumpHeaders            builds build/DumpHeaders
#   make Testing                builds all projects under Testing/
#   make debug=y                builds a debug version of build/boss
#   make debug=y Testing        builds debug versions of the test projects
#
# notes:
#   make can be run from any directory in the source tree.  the default target
#   in each directory depends on the contents of that directory.  for example,
#   the default target in Testing/DumpHeaders/ is the DumpHeaders binary,
#   whereas the default target in Support/ is the collection of object files
#   generated by the sources in the Support/ directory.


#
# Variables
#

CXX      := g++
CXXFLAGS := -pipe --std=gnu++0x -Wall -Wextra -Wno-multichar
ifeq (y,$(strip ${debug}))
  CXXFLAGS := -O0 -ggdb3 $(CXXFLAGS)
else
  CXXFLAGS := -O2 $(CXXFLAGS)
endif
ifeq (y,$(strip ${profile}))
  CXXFLAGS := -pg $(CXXFLAGS)
endif
ifeq (y,$(strip ${coverage}))
  CXXFLAGS := --coverage $(CXXFLAGS)
endif
INCLUDES := .

PROG_BOSS   := boss
BUILD_DIR   := build
TARGET_BOSS := $(BUILD_DIR)/$(PROG_BOSS)
BOSS_LIBS   := boost_system boost_regex boost_filesystem boost_program_options curl


#
# Targets
#

.PHONY: $(PROG_BOSS) clean

# set default target before including other makefiles
all: $(PROG_BOSS)

include Support/Makefile.inc Parsing/Makefile.inc Common/Makefile.inc Testing/Makefile.inc

$(PROG_BOSS): $(TARGET_SUPPORT) $(TARGET_PARSING) $(TARGET_COMMON) $(TARGET_BOSS)

$(BUILD_DIR)/%.o: %.cpp
	$(CXX) $(CXXFLAGS) -MMD -MP -MT $@ -MF $(BUILD_DIR)/$(<:.cpp=.d) $(addprefix -I,$(INCLUDES)) -o $@ -c $<

clean:
	$(RM) -r $(BUILD_DIR)

$(TARGET_BOSS): $(SUPPORT_OBJS) $(PARSING_OBJS) $(COMMON_OBJS)
	$(CXX) $(CXXFLAGS) -o $@ $(addprefix -l,$(BOSS_LIBS)) $^
